name: Merge Pending Release

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Determine release branch name
        id: branch
        run: |
          # Get current version using the same logic as stage-release
          OUTPUT=$(bun run scripts/get-next-version.ts 2>&1 | tail -n 1)
          CURRENT_VERSION=$(echo "$OUTPUT" | jq -r '.version')
          BRANCH="staging/v${CURRENT_VERSION}-next"
          echo "name=$BRANCH" >> $GITHUB_OUTPUT
          echo "Release branch: $BRANCH"

      - name: Find release PR
        id: find_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ steps.branch.outputs.name }}"

          # Check if branch exists
          if ! git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
            echo "Branch $BRANCH does not exist"
            exit 1
          fi

          # Find PR from this exact branch to release
          PR_NUMBER=$(gh pr list --base release --head "$BRANCH" --state open --json number --jq '.[0].number // empty')

          if [ -z "$PR_NUMBER" ]; then
            echo "No open PR found from $BRANCH to release"
            exit 1
          fi

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "Found PR #$PR_NUMBER"

      - name: Verify PR is ready (not draft)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.find_pr.outputs.pr_number }}"
          IS_DRAFT=$(gh pr view "$PR_NUMBER" --json isDraft --jq '.isDraft')

          if [ "$IS_DRAFT" = "true" ]; then
            echo "❌ PR #$PR_NUMBER is still in draft state"
            echo "Mark the PR as ready for review before deploying."
            exit 1
          fi

          echo "✅ PR #$PR_NUMBER is ready for merge"

      - name: Verify PR checks passed
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.find_pr.outputs.pr_number }}"

          # Get the PR's check status
          STATUS=$(gh pr checks "$PR_NUMBER" --json bucket,state --jq 'map(select(.bucket != "")) | if length == 0 then "no_checks" elif all(.state == "SUCCESS") then "success" else "failure" end')

          if [ "$STATUS" = "no_checks" ]; then
            echo "⚠️  No CI checks found on PR #$PR_NUMBER"
            echo "Proceeding anyway..."
          elif [ "$STATUS" != "success" ]; then
            echo "❌ PR #$PR_NUMBER has failing or pending checks:"
            gh pr checks "$PR_NUMBER"
            exit 1
          else
            echo "✅ All checks passed on PR #$PR_NUMBER"
          fi

      - name: Force push to release
        run: |
          BRANCH="${{ steps.branch.outputs.name }}"
          git fetch origin "$BRANCH"
          git push origin "origin/$BRANCH:release" --force
          echo "Force pushed $BRANCH to release"

      - name: Add release comment to PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.find_pr.outputs.pr_number }}"
          # GitHub auto-detects the PR as merged after force push
          gh pr comment "$PR_NUMBER" --body "✅ Released via force-push to \`release\` branch." || true
          echo "PR #$PR_NUMBER should now show as merged"
